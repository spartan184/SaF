;----------------------------------------------------------------------------------------------
Object RivendellCastleUpgrade

	; *** ART Parameters ***
	SelectPortrait                  = BPRivendellCastleUpgrade
	
	; ----------------------------------------------------------------------------------------------
	; -- Trebuchet
	; ----------------------------------------------------------------------------------------------
	Draw                            = W3DScriptedModelDraw Draw_Trebuchet
		OkToChangeModelColor          = Yes

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth             = No

		DefaultModelConditionState
			Model				                = ABConsBal
		End

		ModelConditionState           = WORLD_BUILDER
  		Model                     	= ABWallPost ;ABConsBal
  	End

		IdleAnimationState
			StateName                   = Complete
			BeginScript
				CurDrawableHideModule("Draw_Trebuchet")
			EndScript
		End

		ModelConditionState           = SOLD
			Model                       = ABConsBal  
		End
		
		AnimationState                = SOLD
			Animation
				AnimationName             = ABConsBal_BLD.ABConsBal_BLD
				AnimationMode             = ONCE_BACKWARDS
				AnimationSpeedFactorRange = 3.0 3.0
			End
			Flags                       = START_FRAME_LAST
			EnteringStateFX             = FX_BuildingContructDustCastles
		End

		ModelConditionState           = UPGRADE_TREBUCHET DAMAGED
			Model                       = ABConsBal ;GBCASTTREB_D1  
		End
	    
		AnimationState                = UPGRADE_TREBUCHET DAMAGED
	;      EnteringStateFX          = FX_MinWallATransitionDamaged
		End

		ModelConditionState           = UPGRADE_TREBUCHET REALLYDAMAGED
			Model                       = ABConsBal ;GBCASTTREB_D2
		End
		
		AnimationState                = UPGRADE_TREBUCHET REALLYDAMAGED
       		Animation				        =	ReallyDamagedanimation
				AnimationName		          =	ABConsBal.ABConsBal ;GBCASTTREB_D2.GBCASTTREB_D2
				AnimationMode		          =	ONCE
   			End
	;        EnteringStateFX        = FX_MinWallATransitionReallyDamaged
		End

		ModelConditionState           = UPGRADE_TREBUCHET RUBBLE
		Model                         = ABConsBal ;GBCASTTREB_D3
		End
	    
		AnimationState                = UPGRADE_TREBUCHET RUBBLE
			StateName                   = Complete
			Animation				            =	Death
				AnimationName		          =	ABConsBal.ABConsBal ;GBCASTTREB_D3.GBCASTTREB_D3
				AnimationMode		          =	ONCE
			End
	;        EnteringStateFX        = FX_MinWallATransitionRubble
			EnteringStateFX	            = FX_WallDie
		End      

		ModelConditionState           = UPGRADE_TREBUCHET POST_RUBBLE
			Model                       = None
		End

		ModelConditionState           = UPGRADE_TREBUCHET POST_COLLAPSE
			Model                       = None
		End		
		
		TransitionState               = TRANS_IdleToBuild
			Animation
				AnimationName				      = ABConsBal_BLD.ABConsBal_BLD
				AnimationMode				      = ONCE
				AnimationSpeedFactorRange	= 1.0 1.0
			End
			EnteringStateFX             = FX_BuildingContructDustCastles
		End

		AnimationState                = UPGRADE_TREBUCHET
			BeginScript
				Prev                      = CurDrawablePrevAnimationState()
				if Prev                   == "Complete" then CurDrawableSetTransitionAnimState("TRANS_IdleToBuild") end
			EndScript
			Flags                       = START_FRAME_LAST
			Animation
				AnimationName             = ABConsBal_BLD.ABConsBal_BLD
				AnimationMode             = ONCE
			End
		End
	
	End
		
	;----------------------------------------------------------------------------------------------
;;
;;	Newly-created field: the OverrideTooltip field! Notes
;;
;;		So this field has limitations, first and foremost being that it should
;;	only be applied to one drawModule.  When objects are drawn, all drawModules are used; so
;;	if you add OverrideTooltips to multiple drawModules, the lowest one (defined in the ini)
;;	will always take precedence over any others.
;;
;;		ReferenceDisplayName is a keyword to the drawable which tells it to ... reference the
;;	DisplayName of the object.
;;
	Draw                            = W3DScriptedModelDraw Draw_Picker

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth             = No
	
		DefaultModelConditionState
			Model                       = GBCASTWallOB
		End
		
	End
	
	; ----------------------------------------------------------------------------------------------
	; -- Decal
	; ----------------------------------------------------------------------------------------------
	Draw                            = W3DScriptedModelDraw Draw_Decal

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth             = No
	
		DefaultModelConditionState
			Model                       = abfoundationup
		End

		IdleAnimationState
			BeginScript
				CurDrawableShowModule("Draw_Decal")
				CurDrawableShowModule("Draw_Picker")
			EndScript
		End
		
		AnimationState                = JUST_BUILT
			BeginScript
				CurDrawableHideModule("Draw_Decal")
				CurDrawableShowModule("Draw_Picker")
			EndScript
		End

		AnimationState                = SOLD
			BeginScript
				CurDrawableHideModule("Draw_Decal"); since the command is not yet available
			EndScript
		End

		AnimationState                = RUBBLE
			BeginScript
				CurDrawableHideModule("Draw_Decal")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End
		
		AnimationState                = UPGRADE_POSTERN_GATE
			BeginScript
				CurDrawableShowModule("Draw_PosternGate")
				CurDrawableShowModule("Draw_Decal")			; Don't want to hide the decal cause this would give away our stealthed gate.
				;			
				CurDrawableHideModule("Draw_Tower")
				CurDrawableHideModule("Draw_Trebuchet")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End
		
		AnimationState                = UPGRADE_TREBUCHET
			BeginScript
				CurDrawableShowModule("Draw_Trebuchet")
				;			
				CurDrawableHideModule("Draw_Decal")
				CurDrawableHideModule("Draw_PosternGate")
				CurDrawableHideModule("Draw_Tower")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End
		
		AnimationState                = UPGRADE_GARRISON
			BeginScript
				CurDrawableShowModule("Draw_Tower")
				;			
				CurDrawableHideModule("Draw_Decal")
				CurDrawableHideModule("Draw_PosternGate")
				CurDrawableHideModule("Draw_Trebuchet")
				CurDrawableHideModule("Draw_Picker")
			EndScript
		End

	End

	; ----------------------------------------------------------------------------------------------
	; -- Postern Gate
	; ----------------------------------------------------------------------------------------------
	Draw                            = W3DScriptedModelDraw Draw_PosternGate

		ExtraPublicBone               = PATH01
		ExtraPublicBone               = PATH02
		ExtraPublicBone               = PATH03
		ExtraPublicBone               = PATH04

		DefaultModelConditionState
			Model				                = ABWallPost
		End

		IdleAnimationState
			BeginScript
				CurDrawableHideModule("Draw_PosternGate")
			EndScript
		End


		ModelConditionState           = SOLD
			Model                       = ABWallPost 
		End
		AnimationState                = SOLD
			Animation
				AnimationName             = GBCASTPOST.GBCASTPOST
				AnimationMode             = ONCE_BACKWARDS
				AnimationSpeedFactorRange = 3.0 3.0
			End
			Flags                       = START_FRAME_LAST
			EnteringStateFX             = FX_BuildingContructDustCastlesCentre
		End


		ModelConditionState           = UPGRADE_POSTERN_GATE DAMAGED
			Model                       = ABWallPost ;GBCASTPOST_D1  
		End
	    
		AnimationState                = UPGRADE_POSTERN_GATE DAMAGED
	;      EnteringStateFX          = FX_MinWallATransitionDamaged
		End

		ModelConditionState           = UPGRADE_POSTERN_GATE REALLYDAMAGED
		Model                         = ABWallPost ;GBCASTPOST_D2
		End
		AnimationState                = UPGRADE_POSTERN_GATE REALLYDAMAGED
	;        EnteringStateFX        = FX_MinWallATransitionReallyDamaged
		End

		ModelConditionState           = UPGRADE_POSTERN_GATE RUBBLE
		Model                         = GBCASTPOST_D3
		End
	    
		AnimationState                = UPGRADE_POSTERN_GATE RUBBLE
			Animation				            =	Death
				AnimationName		          =	GBCASTPOST_D3.GBCASTPOST_D3
				AnimationMode		          =	ONCE
			End
	;        EnteringStateFX        = FX_MinWallATransitionRubble
			EnteringStateFX	            = FX_WallDie
		End      

		ModelConditionState           = UPGRADE_POSTERN_GATE POST_RUBBLE
			Model                       = None
		End

		ModelConditionState           = UPGRADE_POSTERN_GATE POST_COLLAPSE
			Model                       = None
		End		
		

		AnimationState                = UPGRADE_POSTERN_GATE
			Animation
				AnimationName             = GBCASTPOST.GBCASTPOST
				AnimationMode             = ONCE
			End
			EnteringStateFX             = FX_BuildingContructDustCastlesCentre
		End
	
	End
		
	; ----------------------------------------------------------------------------------------------
	; -- Tower
	; ----------------------------------------------------------------------------------------------
	Draw                            = W3DScriptedModelDraw Draw_Tower

		ExtraPublicBone               = Arrow_01
		ExtraPublicBone               = Arrow_02
		ExtraPublicBone               = Arrow_03
		ExtraPublicBone               = Arrow_04
		ExtraPublicBone               = Arrow_05
		ExtraPublicBone               = Arrow_06
		ExtraPublicBone               = Arrow_07
		ExtraPublicBone               = Arrow_08
		ExtraPublicBone               = Arrow_09
		ExtraPublicBone               = Arrow_10
		ExtraPublicBone               = Arrow_11
		ExtraPublicBone               = Arrow_12

		; Don't want to change the hidden state of this when the postern gate is stealthed.
		AffectedByStealth             = No

		DefaultModelConditionState
			Model				                = ABConsTwr
			WeaponLaunchBone            = PRIMARY ARROW_
		End
		
		; This idle state is required simply to make sure the tower visual
		; mesh is invisible so we can't pick it when it's underground.
		; The actual state is not needed.
		IdleAnimationState
			StateName                   = Complete
			BeginScript
				CurDrawableHideModule("Draw_Tower")
			EndScript
		End
		
		; Sold Animations
		ModelConditionState           = SOLD
			Model                       = ABConsTwr
		End
		
		AnimationState                = SOLD
			Animation
				AnimationName             = ABConsTwr_BLD.ABConsTwr_BLD
				AnimationMode             = ONCE_BACKWARDS
				AnimationSpeedFactorRange = 3.0 3.0
			End
			Flags                       = START_FRAME_LAST
			EnteringStateFX             = FX_BuildingContructDustCastles
		End

		; Damaged D1
		ModelConditionState           = UPGRADE_GARRISON DAMAGED
			Model                       = ABConsTwr_D1
		End
	    
		AnimationState                = UPGRADE_GARRISON DAMAGED
	;      EnteringStateFX          = FX_MinWallATransitionDamaged
		End
		
		; Damaged D2
		ModelConditionState           = UPGRADE_GARRISON REALLYDAMAGED
			Model                       = ABConsTwr_D2
		End
		
		AnimationState                = UPGRADE_GARRISON REALLYDAMAGED
      Animation				        		=	ReallyDamagedanimation
				AnimationName		          =	ABConsTwr_D2.ABConsTwr_D2 ; GBCASTTOWR_D2.GBCASTTOWR_D2
				AnimationMode		          =	ONCE
  		End
	;        EnteringStateFX        = FX_MinWallATransitionReallyDamaged
		End

		; Damaged D3 
		ModelConditionState           = UPGRADE_GARRISON RUBBLE
			Model                       = ABConsTwr_D2 ;GBCASTTOWR_D3
		End
	    
		AnimationState                = UPGRADE_GARRISON RUBBLE
			StateName                   = Complete
			Animation				            =	Death
				AnimationName		          =	ABConsTwr_D2.ABConsTwr_D2 ;GBCASTTOWR_D3.GBCASTTOWR_D3
				AnimationMode		          =	ONCE
			End
			EnteringStateFX	            = FX_WallDie
		End      

		ModelConditionState           = UPGRADE_GARRISON POST_RUBBLE
			Model                       = None
		End

		ModelConditionState           = UPGRADE_GARRISON POST_COLLAPSE
			Model                       = None
		End		

		TransitionState				        =	TRANS_IdleToBuild
			Animation
				AnimationName				      = ABConsTwr.ABConsTwr ;ABConsTwr_BLD.ABConsTwr_BLD
				AnimationMode				      = ONCE
				AnimationSpeedFactorRange	= 3.0 3.0
			End
			EnteringStateFX             = FX_BuildingContructDustCastles
		End

		; Just play the last frame, so we don't get the build anim again.
		AnimationState                = UPGRADE_GARRISON
			
			; If we're complete then transition via showing and build anim.
			BeginScript
				Prev                      = CurDrawablePrevAnimationState()
				if Prev                   == "Complete" then CurDrawableSetTransitionAnimState("TRANS_IdleToBuild") end
			EndScript
		
			Flags                       = START_FRAME_LAST
			Animation
				AnimationName             = ABConsTwr.ABConsTwr ;ABConsTwr_BLD.ABConsTwr_BLD
				AnimationMode             = ONCE
			End
		End

	End

	;----------------------- AUDIO -------------------------
	VoiceSelect				              = Gui_PlotSelect
	SoundOnDamaged			            = BuildingLightDamageStone
	SoundOnReallyDamaged		        = BuildingHeavyDamageStone
	VoiceSelectUnderConstruction	  = BuildingEvilVoiceSelectUnderConstruction

	; Change selection sounds based on upgrades
	ClientBehavior                  = UpgradeSoundSelectorClientBehavior ModuleTag_UpgradeSoundSelector
		SoundUpgrade                  = Upgrade_PosternGate								; EVERYTHING on this line must be present
			ExcludedUpgrades            = Upgrade_OpenGarrison Upgrade_TrebuchetTurret		; NOTHING on this line can be present
			VoiceSelect                 = GondorPosternGateSelect
		End
		
		SoundUpgrade                  = Upgrade_OpenGarrison								; EVERYTHING on this line must be present
			ExcludedUpgrades            = Upgrade_PosternGate Upgrade_TrebuchetTurret		; NOTHING on this line can be present
			VoiceSelect                 = GondorBattleTowerSelect
		End

		SoundUpgrade                  = Upgrade_TrebuchetTurret							; EVERYTHING on this line must be present
			ExcludedUpgrades            = Upgrade_PosternGate Upgrade_OpenGarrison			; NOTHING on this line can be present
			VoiceSelect                 = GondorArmorySelect
		End
	End

	
	; ***DESIGN parameters ***
	DisplayName		                  = OBJECT:RivendellCastleWallUpgrade
	EditorSorting	                  = STRUCTURE
	Side			                      = Rivendell
	IsTrainable		                  = No
	CommandSet						          = RivendellCastleWallCommandSet

	ArmorSet
		Conditions	                  = None
		Armor		                      = GondorCastleWallUpgrade
		DamageFX	                    = MinasWallADamageFX
	End
	
	ArmorSet
		Conditions	                  = AS_TOWER
		Armor		                      = GondorCastleWallUpgradeAsTower
		DamageFX	                    = MinasWallADamageFX
	End


	WeaponSet
		Conditions			              = None
	End
	
	WeaponSet
		Conditions			              = PLAYER_UPGRADE
		Weapon				                = PRIMARY CastleWallUpgradeBow
		AutoChooseSources	            = PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI
	End
	
	
	Behavior                        = ProductionUpdate ProductionUpdateModuleTag
		; nothing, but is required if we have any Object-level Upgrades!
	End

	Body				                    = ActiveBody ModuleTag_02
		MaxHealth		                  = GONDOR_CASTLE_WALL_UPGRADE_HEALTH
	End
	
	; ---------------------------------------------------------------------
	; -- Tower
	; ---------------------------------------------------------------------
	Behavior                        = WeaponSetUpgrade ModuleTag_Add5ArchersToAllKeepsAndBattleTowers
		TriggeredBy			              = Upgrade_OpenGarrison
		ConflictsWith		              = Upgrade_PosternGate Upgrade_TrebuchetTurret
	End
	
	Behavior                        = CommandSetUpgrade TheGarrisonCommandSet
		TriggeredBy			              = Upgrade_OpenGarrison
		ConflictsWith		              = Upgrade_PosternGate Upgrade_TrebuchetTurret
		CommandSet			              = SellableCommandSet
	End
	
	Behavior                        = AttributeModifierUpgrade DontShootWhilstBuilding
		TriggeredBy			              = Upgrade_OpenGarrison
		ConflictsWith		              = Upgrade_PosternGate Upgrade_TrebuchetTurret
		AttributeModifier	            = PreventFromShooting
	End
	
	Behavior                        = AudioLoopUpgrade ModuleTag_GarrisonBuildLoop
		; Play a "build loop" while the garrison is building up
		TriggeredBy			              = Upgrade_OpenGarrison
		ConflictsWith		              = Upgrade_PosternGate Upgrade_TrebuchetTurret
		SoundToPlay			              = BuildingConstructionLoop
		KillOnDeath                   = Yes
		KillAfterMS			              = 6166  ; Should match the length of the build-up animation [Or a little shorter since sounds take a little while to die]
	End
	
	Behavior                        = ArmorUpgrade ArmorUpgradeModuleTag1
		TriggeredBy			              = Upgrade_OpenGarrison
	  ArmorSetFlag		              = AS_TOWER
	End
	
	Behavior                        = TooltipUpgrade ModuleTag_GarrisonTooltip
		TriggeredBy				            = Upgrade_OpenGarrison
		ConflictsWith			            = Upgrade_PosternGate Upgrade_TrebuchetTurret
		DisplayName				            = OBJECT:RivendellWallTower
		Description				            = OBJECT:GondorBattleTowerDescription
	End
	
	; This isn't a geom upgrade, we just need something that doesn't do anything
	; to hook onto this upgrade.
	Behavior                        = GeometryUpgrade ModuleTag_FireArrows
		TriggeredBy			              = Upgrade_BattleTowersToUseFireArrows
		ConflictsWith		              = Upgrade_PosternGate Upgrade_TrebuchetTurret
	End
	
	Behavior                        = GeometryUpgrade ModueTag_TowerGeom
		TriggeredBy			              = Upgrade_OpenGarrison
		ConflictsWith		              = Upgrade_PosternGate Upgrade_TrebuchetTurret
		ShowGeometry		              = TowerGeom
		HideGeometry		              = TrebGeom DummyGeom
		CustomAnimAndDuration	        = AnimState:UPGRADE_GARRISON AnimTime:0
	End
	
	; ---------------------------------------------------------------------
	; -- Trebuchet
	; ---------------------------------------------------------------------	
	Behavior                        = GeometryUpgrade ModueTag_TrebGeom
		TriggeredBy			              = Upgrade_TrebuchetTurret
		ConflictsWith		              = Upgrade_PosternGate Upgrade_OpenGarrison
		ShowGeometry		              = TrebGeom
		HideGeometry		              = TowerGeom DummyGeom
		WallBoundsMesh		            = P2
		;RampMesh1			                = P3
		
		CustomAnimAndDuration	        = AnimState:UPGRADE_TREBUCHET AnimTime:0
		
	End
	
	Behavior                        = AudioLoopUpgrade ModuleTag_TrebBuildLoop
		; Play a "build loop" while the treb is building up
		TriggeredBy			              = Upgrade_TrebuchetTurret 
		ConflictsWith		              = Upgrade_PosternGate Upgrade_OpenGarrison
		SoundToPlay			              = BuildingConstructionLoop
		KillOnDeath                   = Yes
		KillAfterMS			              = 6166  ; Should match the length of the build-up animation [Or a little shorter since sounds take a little while to die]
	End
	
	Behavior                        = CommandSetUpgrade ModueTag_TrebCommandSet
		TriggeredBy			              = Upgrade_TrebuchetTurret
		ConflictsWith		              = Upgrade_HasWallTrebuchet Upgrade_PosternGate Upgrade_OpenGarrison
		CommandSet			              = GondorCastleWallUpgradeCommandSetBuyNewTreb
	End
	
	Behavior                        = ArmorUpgrade ArmorUpgradeModuleTag2
		TriggeredBy			              = Upgrade_TrebuchetTurret
	  ArmorSetFlag		           	  = AS_TOWER
	End
	
	Behavior                        = CommandSetUpgrade ModueTag_TrebCommandSet3
		TriggeredBy			              = Upgrade_HasWallTrebuchet Upgrade_TrebuchetTurret
		ConflictsWith		              = Upgrade_OpenGarrison Upgrade_PosternGate
		CommandSet			              = SellableCommandSet
		RequiresAllTriggers	          = Yes
	End
	
	Behavior                        = AttributeModifierUpgrade DontShootWhilstBuilding2	; Required for the buiding canceling - don't ask.
		TriggeredBy			              = Upgrade_TrebuchetTurret
		AttributeModifier	            = PreventFromShooting
	End
	
	Behavior                        = TooltipUpgrade ModuleTag_TrebuchetTooltip
		TriggeredBy				            = Upgrade_TrebuchetTurret
		ConflictsWith			            = Upgrade_OpenGarrison Upgrade_PosternGate
		DisplayName				            = OBJECT:RivendellBallistaOutcropping
	End
	
	; ---------------------------------------------------------------------
	; -- Postern Gate
	; ---------------------------------------------------------------------	
	Behavior                        = DynamicPortalBehaviour PosternGatePortal
		TriggeredBy				            = Upgrade_PosternGate
		ConflictsWith			            = Upgrade_OpenGarrison Upgrade_TrebuchetTurret
		CustomAnimAndDuration	        = AnimState:UPGRADE_POSTERN_GATE AnimTime:0
		ActivationDelaySeconds	      = 7.0
		
		AllowKindOf		                = INFANTRY CAVALRY
		RejectKindOf	                = MONSTER MACHINE ARMY_OF_DEAD
		BonePrefix		                = PATH
		NumberOfBones	                = 4
		WayPoint		                  = Index:0	Type:Walk	; 0
		WayPoint		                  = Index:1	Type:Walk	; 1
		WayPoint		                  = Index:2	Type:Walk	; 2
		WayPoint		                  = Index:3	Type:Walk	; 3
		WayPoint		                  = Index:2	Type:Walk	; 4
		WayPoint		                  = Index:1	Type:Walk	; 5
		Link			                    = From:0 Via:4 Via:5 To:3
		Link			                    = From:3 Via:1 Via:2 To:0
	End
	
	Behavior                        = CommandSetUpgrade ModueTag_PosternGateCommandSet
		TriggeredBy			              = Upgrade_PosternGate
		ConflictsWith		              = Upgrade_OpenGarrison Upgrade_TrebuchetTurret
		CommandSet			              = SellableCommandSet
	End
	
	Behavior                        = AttributeModifierUpgrade DontShootWhilstBuilding3	; Required for the buiding canceling - don't ask.
		TriggeredBy			              = Upgrade_PosternGate
		AttributeModifier	            = PreventPosternGateFromShooting
	End	
	
	Behavior                        = AudioLoopUpgrade ModuleTag_GateBuildLoop
		; Play a "build loop" while the gate is building up
		TriggeredBy			              = Upgrade_PosternGate
		ConflictsWith		              = Upgrade_TrebuchetTurret Upgrade_OpenGarrison
		SoundToPlay			              = BuildingConstructionLoop
		KillOnDeath                   = Yes
		KillAfterMS			              = 6166  ; Should match the length of the build-up animation [Or a little shorter since sounds take a little while to die]
	End
	
	Behavior                        = StealthUpgrade ModuleTag_StealthUpgrade
		TriggeredBy			              = Upgrade_PosternGate
		ConflictsWith		              = Upgrade_TrebuchetTurret Upgrade_OpenGarrison
	End
	
	Behavior                        = TooltipUpgrade ModuleTag_PosternGateTooltip
		TriggeredBy				            = Upgrade_PosternGate
		ConflictsWith			            = Upgrade_TrebuchetTurret Upgrade_OpenGarrison
		DisplayName				            = OBJECT:RivendellPosternGate
	End
	
	; ---------------------------------------------------------------------
	; -- Trebuchet
	; ---------------------------------------------------------------------
	Behavior                        = ObjectCreationUpgrade MakeTheFreeTreb
		TriggeredBy		                = Upgrade_TrebuchetTurret
		ConflictsWith	                = Upgrade_OpenGarrison Upgrade_PosternGate
		Delay			                    = GONDOR_WALLTREBUCHET_CREATE_DELAY
		RemoveUpgrade	                = Upgrade_WallTrebuchetButtonEnable
		GrantUpgrade	                = Upgrade_HasWallTrebuchet
		DestroyWhenSold               = Yes
		DeathAnimAndDuration          = AnimState:DEATH_2 AnimTime:999999
		Offset			                  = X:60.0 Y:0.0 Z:80
	End
	
	Behavior                        = ObjectCreationUpgrade MakeTheFreeTreb2
		TriggeredBy		                = Upgrade_HasWallTrebuchet
		ConflictsWith	                = Upgrade_OpenGarrison Upgrade_PosternGate
		Delay			                    = 0.0
		RemoveUpgrade	                = Upgrade_WallTrebuchetButtonEnable
		ThingToSpawn	                = RivendellWallBallista
		Offset												= X:52.0 Y:2.0 Z:80
		FadeInTime										= 600
	End
	
	Behavior                        = SlaveWatcherBehavior WatchTheTreb
		RemoveUpgrade		              =	Upgrade_HasWallTrebuchet			;when our slave dies, remove this upgrade, so we can get the upgrade again.
		GrantUpgrade		              =	Upgrade_WallTrebuchetButtonEnable	;when our slave dies, enable the button that allows us to buy a new one
	End

	; --
	Behavior                        = CastleMemberBehavior ModuleTag_CMB
		StoreUpgradePrice             = Yes ; We want to overload the refund price with any upgrades purchased.
		CountsForEvaCastleBreached    = No   ; This is just the floating button
	End 
	
	Behavior                        = FoundationAIUpdate ModuleTag_FoundationAI
	End
	
	Behavior                        = WallUpgradeUpdate ModuleTag_Update
	End

	Behavior                        = AIUpdateInterface ModuleTag_SoWeCanUseWeapon
 		AutoAcquireEnemiesWhenIdle	  = Yes
 		MoodAttackCheckRate			      = 250
		AILuaEventsList				        = GarrisonableFunctions
 	End

 	Behavior                        = FireWeaponWhenDeadBehavior FireDeadTag1
		DeathTypes					          = ALL
		StartsActive				          = Yes
		ActiveDuringConstruction	    = Yes
		DeathWeapon					          = CastleUpgradeDeath
	End	

	; Turned on for the postern gate upgrade.
	Behavior                        = StealthUpdate ModuleTag_Stealth
		StealthDelay                  = 1000					; msec
		FriendlyOpacityMin            = 25.0%
		FriendlyOpacityMax            = 75.0%
		DetectedByAnyoneRange		      = 20.0
		DetectedByFriendliesOnly	    = Yes
		PulseFrequency                = 750				; msec
		InnateStealth                 = Yes
		StartsActive				          = No
	End

	KindOf							            = STRUCTURE SELECTABLE IMMOBILE CHUNK_VENDOR CAN_ATTACK WALL_UPGRADE WALK_ON_TOP_OF_WALL NOT_AUTOACQUIRABLE ;;;;;;;;  This needs to go in when being obscured by the wall is fixed -> ATTACK_NEEDS_LINE_OF_SIGHT GARRISON
	RadarPriority					          = STRUCTURE
	VisionRange						          = GONDOR_ARCHER_VISION_RANGE
	KeepSelectableWhenDead			    = No
	
	GeometryRotationAnchorOffset	  = X:375.0 Y:0.0
	GeometryIsSmall					        = No
	Geometry						            = BOX
	GeometryMajorRadius				      = 1.0
	GeometryMinorRadius				      = 1.0
	GeometryHeight					        = 1.0
	GeometryName					          = DummyGeom
	GeometryActive					        = Yes
	
	AdditionalGeometry				      = BOX
	GeometryMajorRadius   					= 25
	GeometryMinorRadius   					= 25
	GeometryHeight					        = 55.0
	GeometryOffset									= X:60 Y:0 Z:100	
	GeometryName					          = TrebGeom
	GeometryActive					        = No
	
	AdditionalGeometry				      = BOX
	GeometryMajorRadius				      = 20.0
	GeometryMinorRadius				      = 20.0
	GeometryHeight					        = 120.0
	GeometryOffset					        = X:45.0 Y:0.0 Z:0.0
	GeometryName					          = TowerGeom
	GeometryActive					        = No
	
	GeometryContactPoint	          = X: 37.0	Y:-16.0		Z:120	Swoop
	GeometryContactPoint	          = X: 37.0	Y:  0.0		Z:0		Grab
	GeometryContactPoint	          = X: 37.0	Y: 16.0		Z:120	Swoop
	Shadow							            = SHADOW_VOLUME
	
End