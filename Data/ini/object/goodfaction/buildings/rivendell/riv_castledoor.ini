;------------------------------------------------------------------------------------------
Object RohanCastleDoor

SelectPortrait = BPRohanCastleGate

  ; *** ART Parameters ***

  Draw = W3DScriptedModelDraw ModuleTag_Draw
    OkToChangeModelColor  = Yes
    UseStandardModelNames = Yes

    DefaultModelConditionState  
      Model = RBCASTDOOR
    End

    ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED 
        Model             = RBCASTDOOR_A
        ParticleSysBone   = DUSTBONE BuildingContructDust
    End
    AnimationState        = ACTIVELY_BEING_CONSTRUCTED 
        StateName                = STATE_None
            Animation           = RBCASTDOOR_A
                AnimationName   = RBCASTDOOR_A.RBCASTDOOR_A
                AnimationMode   = MANUAL
            End
        Flags                    = START_FRAME_FIRST
    End

    ModelConditionState   = DESTROYED_WHILST_BEING_CONSTRUCTED
        Model              = RBCASTDOOR_A
        ParticleSysBone   = DUSTBONE BuildingContructDust
    End  
    AnimationState    = DESTROYED_WHILST_BEING_CONSTRUCTED
        StateName        = STATE_DetroyedConstructing
        EnteringStateFX    = FX_GondorCastleGateDestroy
        Animation
            AnimationName        = RBCASTDOOR_A.RBCASTDOOR_A
            AnimationMode        = ONCE_BACKWARDS
            AnimationBlendTime    = 90    ; 3 seconds * 30 frames
        End
        ; Specifically no start last frame flag here.
        Flags = START_FRAME_FIRST
    End

    ModelConditionState  = RUBBLE DOOR_1_OPENING
        Model         = RBCASTDOOR_D4  
    End
    TransitionState = TRANS_IntoRubble4
        Animation = D3
            AnimationName        = RBCASTDOOR_D4.RBCASTDOOR_D4
            AnimationMode        = ONCE
            AnimationBlendTime = 0
        End
        EnteringStateFX    = FX_GondorCastleGateDestroy
    End
    AnimationState = RUBBLE DOOR_1_OPENING
        Flags = START_FRAME_LAST
        StateName = STATE_Rubble
        Animation                =    Death
            AnimationName        =    RBCASTDOOR_D4.RBCASTDOOR_D4
            AnimationMode        =    ONCE
        End
        BeginScript
            Prev = CurDrawablePrevAnimationState()
            if Prev == "STATE_None" or Prev == "STATE_Open" or Prev == "STATE_Closed" or Prev == "TRANS_Closed_To_Open" or Prev == "TRANS_Open_To_Closed"
            then
                ; Only play the rubble anim if we havn't come from another rubble.
                CurDrawableSetTransitionAnimState("TRANS_IntoRubble4")
            end
        EndScript
    End      

    ModelConditionState  = RUBBLE DOOR_1_CLOSING
        Model         = RBCASTDOOR_D3
    End
    TransitionState = TRANS_IntoRubble3
        Animation = D4
            AnimationName        = RBCASTDOOR_D3.RBCASTDOOR_D3
            AnimationMode        = ONCE
            AnimationBlendTime = 0
        End
        EnteringStateFX    = FX_GondorCastleGateDestroy
    End
    AnimationState = RUBBLE DOOR_1_CLOSING
        Flags = START_FRAME_LAST
        StateName = STATE_Rubble
        Animation                =    Death
            AnimationName        =    RBCASTDOOR_D3.RBCASTDOOR_D3
            AnimationMode        =    ONCE
        End
        BeginScript
            Prev = CurDrawablePrevAnimationState()
            if Prev == "STATE_None" or Prev == "STATE_Open" or Prev == "STATE_Closed" or Prev == "TRANS_Closed_To_Open" or Prev == "TRANS_Open_To_Closed"
            then
                ; Only play the rubble anim if we havn't come from another rubble.
                CurDrawableSetTransitionAnimState("TRANS_IntoRubble3")
            end
        EndScript
    End      

;    ModelConditionState  = RUBBLE DOOR_1_OPENING
;      Model         = RBCASTDOOR_D4  
;    End
;    AnimationState = RUBBLE DOOR_1_OPENING
;        Animation = Open 
;            AnimationName    =    RBCASTDOOR_D4.RBCASTDOOR_D4
;            AnimationMode    =    ONCE 
;        End
 ;   End
       
;    ModelConditionState  = RUBBLE
;        Model         = RBCASTDOOR_D3 
;        ParticleSysBone NONE CatapultDestroyDebris
;        ParticleSysBone NONE PCTMediumDust 
 ;   End
 ;    AnimationState = RUBBLE 
;        Animation = Open 
;            AnimationName    =    RBCASTDOOR_D3.RBCASTDOOR_D3
;            AnimationMode    =    ONCE 
;        End
 ;   End
    
    AnimationState = DOOR_1_OPENING
        StateName = STATE_Open   
        Animation = Open 
            AnimationName    =    RBCASTDOOR.RBCASTDOOR
            AnimationMode    =    ONCE 
            AnimationBlendTime = 0
        End
        Flags = START_FRAME_LAST
        BeginScript
            Prev = CurDrawablePrevAnimationState()
            if Prev == "STATE_Closed" then CurDrawableSetTransitionAnimState("TRANS_Closed_To_Open") end
        EndScript
    End
    TransitionState = TRANS_Closed_To_Open
        Animation = Open 
            AnimationName    =    RBCASTDOOR.RBCASTDOOR
            AnimationMode    =    ONCE 
        End
    End
        
    AnimationState = DOOR_1_CLOSING 
        StateName = STATE_Closed 
        Animation = Close 
            AnimationName    =    RBCASTDOOR.RBCASTDOOR
            AnimationMode    =    ONCE_BACKWARDS 
            AnimationBlendTime = 0
        End
        Flags = START_FRAME_FIRST
        BeginScript
            
            Prev = CurDrawablePrevAnimationState()
            if Prev == "STATE_Open" then CurDrawableSetTransitionAnimState("TRANS_Open_To_Closed") end
        EndScript
    End
    TransitionState = TRANS_Open_To_Closed
        Animation = Open 
            AnimationName    =    RBCASTDOOR.RBCASTDOOR
            AnimationMode    =    ONCE_BACKWARDS 
        End
        Flags = START_FRAME_LAST
    End

  End

  ; *** AUDIO Parameters ***

    VoiceSelect        = GateSelect

    SoundOnDamaged        = BuildingLightDamageWood
    SoundOnReallyDamaged    = BuildingHeavyDamageWood


  ; ***DESIGN parameters ***

  DisplayName      = OBJECT:RohanCastleDoor
  Side = Rohan
  EditorSorting   = STRUCTURE
  ThreatLevel = 1.0
    BuildTime           = 180.0           ; in seconds
        BuildCost           = 1000

  VisionRange         = 400.0          ; Shroud clearing distance

  ArmorSet
    Conditions        = None
    Armor             = CastleGateArmor
    DamageFX          = GateDamageFX
  End

    CommandSet = CastleGateCommandSet


    ; *** ENGINEERING Parameters ***  
    KindOf                    = STRUCTURE IMMOBILE SELECTABLE BLOCKING_GATE MADE_OF_WOOD
    RadarPriority            = NOT_ON_RADAR
    KeepSelectableWhenDead    = Yes


    Body                  = ActiveBody ModuleTag_02
        MaxHealth       = 3000.0
    End

  ; Note that structures with "RUBBLE" states should not use DestroyDie; such buildings are 
  ; never truly destroyed, even when reduced to zero health. Also note that garrisonable
  ; buildings automatically stick around because GarrisonContain has it's own DieModule
  Behavior = KeepObjectDie ModuleTag_IWantRubble
  End

    ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
        MaxUpdateRangeCap = 800
        AnimationSound = Sound: MinisTirithGateDie Animation:GBMgatedoorSKL.GBMgatedoorA3 Frames: 1 
    End

    Behavior = GettingBuiltBehavior ModuleTag_GettingBuilt
        SelfBuildingLoop = BuildingConstructionLoop ; Only played if we DON'T spawn a worker
        SelfRepairFromDamageLoop  = NoSound         ; This doesn't cause an animation, so don't bother playing a sound
        SelfRepairFromRubbleLoop  = BuildingConstructionLoop
        SpawnTimer = -1.0 ; Negative means no 'autoheal'
        RebuildTimeSeconds = 120 ;30
    End

    Behavior = TransitionDamageFX ModleTag_hideBustedDoors
        PristineShowSubObject        RBCASTDRR RBCASTDRL
        PristineHideSubObject        RBCASTDRR_D1 RBCASTDRR_D2 RBCASTDRL_D1 RBCASTDRL_D2
        DamagedShowSubObject        RBCASTDRR_D1 RBCASTDRL_D1
        DamagedHideSubObject        RBCASTDRR_D2 RBCASTDRL_D2 RBCASTDRR RBCASTDRL
        ReallyDamagedShowSubObject    RBCASTDRR_D2 RBCASTDRL_D2
        ReallyDamagedHideSubObject  RBCASTDRR_D1  RBCASTDRL_D1 RBCASTDRR RBCASTDRL
        DamagedFXList1 = Loc: X:0 Y:0 Z:0            FXList:FX_BasicSevereScreenShake
         ReallyDamagedFXList1 = Loc: X:0 Y:0 Z:0        FXList:FX_BasicSevereScreenShake
         RubbleFXList1 = Loc: X:0 Y:0 Z:0            FXList:FX_HelmsDeepGateRubble
    End

    Behavior = GateOpenAndCloseBehavior ModuleTag_GATE
        ResetTimeInMilliseconds = 12200 ;important! this must be longer than the gates animation, ir it will twitch
        OpenByDefault = Yes
        PercentOpenForPathing = 50
        SoundOpeningGateLoop = GateOpenStart
        SoundClosingGateLoop = GateCloseStart
        SoundFinishedOpeningGate = GateOpenEnd
        SoundFinishedClosingGate = GateCloseEnd
        TimeBeforePlayingOpenSound = 9500
        TimeBeforePlayingClosedSound = 9500
    End

    Behavior = CastleMemberBehavior ModuleTag_CMB
        CountsForEvaCastleBreached = Yes
    End 

    Geometry              = BOX
    GeometryMajorRadius   = 16.0
    GeometryMinorRadius   = 72.0
    GeometryHeight        = 59.0
    GeometryName          = Closed
    GeometryIsSmall       = No
    
    
    AdditionalGeometry    = BOX
    GeometryMajorRadius   = 28.0
    GeometryMinorRadius   = 7.0
    GeometryHeight        = 59.0    
    GeometryOffset          = X:18 Y:70 Z:0
    GeometryName          = OpenLeft
    
    AdditionalGeometry    = BOX
    GeometryMajorRadius   = 28.0
    GeometryMinorRadius   = 7.0
    GeometryHeight        = 59.0    
    GeometryOffset          = X:18 Y:-70 Z:0
    GeometryName          = OpenRight
    
    GeometryContactPoint = X:36        Y:-72    Z:0 Ram
    GeometryContactPoint = X:18        Y:-72    Z:59
    GeometryContactPoint = X:0        Y:-72    Z:0
    GeometryContactPoint = X:0        Y:-36    Z:59
    GeometryContactPoint = X:0        Y:0        Z:0 Ram
    GeometryContactPoint = X:0        Y:36    Z:59
    GeometryContactPoint = X:0        Y:72    Z:0
    GeometryContactPoint = X:18        Y:72    Z:59
    GeometryContactPoint = X:36        Y:72    Z:0 Ram

    Shadow                = SHADOW_VOLUME
End
