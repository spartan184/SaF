;// aka DwarvenPikemen DwarvenPike Phalanx ErborPikemen
Object DwarvenPhalanx_Summoned              
	;// *** ART Parameters ***

	;// This is required for garrisoned objects - please put in all objects.
	ButtonImage					= upmanymeetingsdwarvenphalanx ;UIEreborPikeman
	SelectPortrait      = upmanymeetingsdwarvenphalanx ;UPEreborPikeman

	Draw = W3DHordeModelDraw ModuleTag_01

		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes

		WadingParticleSys = WaterRipplesTrail  ; used when the unit is wading in shallow water.
		
		DefaultModelConditionState
			Model = duNphalanx_skn
			Skeleton = DUPhalanx_SKL
		End

		ModelConditionState = COMING_OUT_OF_FACTORY
			Model = duNphalanx_skn
		End

		;;//=============== ANIMATIONS ===============================================================
        AnimationState        = THROWN_PROJECTILE
            Animation           = FLYA
                AnimationName     = DUPhalanx_FLYA
                AnimationMode     = LOOP
            End
        End
        AnimationState                            = PASSENGER FREEFALL
            Animation                            = Grabbed
                AnimationName                    = DUPhalanx_FLLA
                AnimationMode                    = LOOP
            End
        End
        AnimationState                            = FREEFALL
            Animation                            = Falling
                AnimationName                    = DUPhalanx_FLYA
                AnimationMode                    = LOOP
                AnimationBlendTime                = 10
            End
        End
        AnimationState        = DYING DEATH_2
            Animation           = LNDA
                AnimationName     = DUPhalanx_IDLA
                AnimationMode     = ONCE
            End
        End
        AnimationState        = DYING SPLATTED
            Animation           = LNDA
                AnimationName     = DUPhalanx_LNDA
                AnimationMode     = ONCE
            End
        End
        AnimationState        = DYING
            Animation           = DIEA
                AnimationName     = DUPhalanx_DIEA
                AnimationMode     = ONCE
                AnimationSpeedFactorRange = 0.8 1.2
            End
            Animation           = DIEA
                AnimationName     = DUPhalanx_DIEB
                AnimationMode     = ONCE
                AnimationSpeedFactorRange = 0.8 1.2
            End
            Animation           = DIEA
                AnimationName     = DUPhalanx_DIEC
                AnimationMode     = ONCE
                AnimationSpeedFactorRange = 0.8 1.2
            End
        End
        AnimationState        = MOVING FIRING_OR_PREATTACK_A
            ShareAnimation        = Yes
            Animation           = RunAndFire
                AnimationName       = DUPhalanx_ATRA
                AnimationMode       = LOOP
            End
            Flags               = RANDOMSTART  
        End
;=======TERROR
        AnimationState                    = MOVING EMOTION_TERROR EMOTION_LOOK_TO_SKY
            ShareAnimation                = Yes
            Animation                    = TerrorFromTheSky
                AnimationName            = DUPhalanx_RUNE
                AnimationMode            = LOOP
            End
        End
        AnimationState                    = MOVING EMOTION_TERROR
            ShareAnimation                = Yes
            Animation                    = Terror
                AnimationName            = DUPhalanx_RUNE
                AnimationMode            = LOOP
            End
        End
;----------------
;=======BACK UP
        AnimationState                =    MOVING BACKING_UP
            ShareAnimation = Yes
            Animation                =    BackingUp
                AnimationName        =    DUPhalanx_BAKA
                AnimationMode        =    LOOP
            End
            Animation                =    BackingUp
                AnimationName        =    DUPhalanx_BAKB
                AnimationMode        =    LOOP
            End            
            Flags                    =    RANDOMSTART 
        End
;--------------------
	AnimationState  = COMING_OUT_OF_FACTORY
		Animation = Being_Built
			AnimationName		= DUPhalanx_RUNC
			AnimationMode		= LOOP
			AnimationBlendTime	= 0
		End
            ParticleSysBone     = None InfantryDustTrails
	End
        AnimationState        = MOVING ALTERNATE_FORMATION WEAPONSET_TOGGLE_1
            ;ShareAnimation = Yes
            StateName            = STATE_EnrouteToPorcupine
            Animation
                AnimationName     = DUPhalanx_WLKB
                AnimationMode     = LOOP
            End
            Flags               = RANDOMSTART
            ParticleSysBone     = None InfantryDustTrails
        End
        AnimationState        = MOVING ALTERNATE_FORMATION 
            ;ShareAnimation = Yes
            StateName            = STATE_EnrouteToPorcupine
            Animation
                AnimationName     = DUPhalanx_WLKB
                AnimationMode     = LOOP
            End
            Flags               = RANDOMSTART
            ParticleSysBone     = None InfantryDustTrails
        End
        AnimationState        = MOVING ATTACKING
            ;ShareAnimation = Yes
            StateName            = STATE_EnrouteToPorcupine
            Animation
                AnimationName     = DUPhalanx_RUNC
                AnimationMode     = LOOP
            End
            Animation
                AnimationName     = DUPhalanx_RUND
                AnimationMode     = LOOP
            End
            Flags               = RANDOMSTART
            ParticleSysBone     = None InfantryDustTrails
        End
        AnimationState        = MOVING
            ShareAnimation = Yes
            Animation           = RUNA
                AnimationName     = DUPhalanx_RUNA
                AnimationMode     = LOOP
            End
            Animation
                AnimationName     = DUPhalanx_RUNB
                AnimationMode     = LOOP
            End
            Flags               = RANDOMSTART
            ParticleSysBone     = None InfantryDustTrails
        End
        AnimationState        =  FIRING_OR_PREATTACK_A
            Animation           = ATKA
                AnimationName     = DUPhalanx_ATKA
                AnimationMode     = ONCE
                UseWeaponTiming        = Yes
            End
            Animation           = ATKA
                AnimationName     = DUPhalanx_ATKB
                AnimationMode     = ONCE
                UseWeaponTiming        = Yes
            End
            ;ParticleSysBone     = None MeleeDust
        End
        AnimationState        = STUNNED_FLAILING
            Animation           = FLYA
                AnimationName     = DUPhalanx_FLYA
                AnimationMode     = LOOP
            End
            Flags               = RANDOMSTART
        End
        AnimationState        = STUNNED_STANDING_UP
            Animation           = GTPA
                AnimationName     = DUPhalanx_GTPA
                AnimationMode     = ONCE
                AnimationSpeedFactorRange = 1.5 1.5
            End
        End
        AnimationState        = STUNNED
            Animation           = LNDA
                AnimationName     = DUPhalanx_LNDA
                AnimationMode     = ONCE
            End
        End
        TransitionState       = TRANS_Plant
            Animation           = PLTA
                AnimationName     = DUPhalanx_PLTA
                AnimationMode     = ONCE
                AnimationSpeedFactorRange = 0.8 1.2
            End
        End
        TransitionState       = TRANS_Unplant
            Animation           = PLTB
                AnimationName     = DUPhalanx_PLTC
                AnimationMode     = ONCE
                AnimationSpeedFactorRange = 0.5 1.2
            End
        End
;------------------ Hit Reaction ---------------------------------------
        AnimationState                        = HIT_REACTION
            Animation                        = HIT REACTION
                AnimationName                = DUPhalanx_HITA
                AnimationMode                = ONCE
            End
        End
;------------------ EMOTIONS -------------------------------------------
;======= APPREHENSIVE
        AnimationState                    = EMOTION_ALERT EMOTION_AFRAID
            ShareAnimation                = Yes
            Animation                    = Apprehensive
                AnimationName            = DUPhalanx_FERA
                AnimationMode            = LOOP    ;Change this to ONCE if adding additional anims
            End
            Flags                        = RANDOMSTART
        End
;======= AFRAID
        AnimationState                    = EMOTION_AFRAID
            ShareAnimation                = Yes
            Animation                    = FERA
                AnimationName            = DUPhalanx_FERA
                AnimationMode            = LOOP
            End
            Flags                        = RANDOMSTART
        End
;======= TAUNTING
        AnimationState                    = EMOTION_TAUNTING ALTERNATE_FORMATION
            Animation                    = TNTA
                AnimationName            = DUPhalanx_TNTA
                AnimationMode            = LOOP
            End
            Animation                    = TNTA
                AnimationName            = DUPhalanx_TNTB
                AnimationMode            = LOOP
            End
        End
        AnimationState                    = EMOTION_TAUNTING
            Animation                    = Taunting
                AnimationName            = DUPhalanx_TNTA
                AnimationMode            = ONCE
            End
            Animation                    = Taunting2
                AnimationName            = DUPhalanx_TNTB
                AnimationMode            = ONCE
            End
            Flags                        = RESTART_ANIM_WHEN_COMPLETE
        End
;======= POINTING
        AnimationState                    = EMOTION_POINTING
            Animation                    = Pointing1
                AnimationName            = DUPhalanx_PNTA
                AnimationMode            = LOOP
            End
            Animation                    = Pointing1
                AnimationName            = DUPhalanx_PNTB
                AnimationMode            = LOOP
            End
            Flags                        = RANDOMSTART
        End
;======= CELEBRATING
        AnimationState                    = EMOTION_CELEBRATING
            Animation                    = CHRA
                AnimationName            = DUPhalanx_CHRA
                AnimationMode            = LOOP
            End
            Animation                    = CHRA
                AnimationName            = DUPhalanx_CHRB
                AnimationMode            = LOOP
            End
            Animation                    = CHRA
                AnimationName            = DUPhalanx_CHRC
                AnimationMode            = LOOP
            End
        End
;-------------- ALERT STATE ------------------------------------------------------------
        AnimationState                    = EMOTION_ALERT
            Animation                    = CHRA
                AnimationName            = DUPhalanx_IDLA
                AnimationMode            = LOOP
            End
        End
;-------------- SELECTED & IDLE --------------------------------------------------------
;======== SELECTED
        AnimationState                    = SELECTED ALTERNATE_FORMATION ; PORCUPINE
            ;ShareAnimation                = Yes
            StateName                    = STATE_SelectedAlternateFormation
            Animation
                AnimationName            = DUPhalanx_PLTB
                AnimationMode            = LOOP
            End
            BeginScript
                Prev = CurDrawablePrevAnimationState()
                if Prev ~= "STATE_SelectedAlternateFormation" and Prev ~= "STATE_Planted" and Prev ~= "TRANS_Plant" then CurDrawableSetTransitionAnimState("TRANS_Plant") end
            EndScript
        End
        AnimationState                    = SELECTED ALTERNATE_FORMATION WEAPONSET_TOGGLE_1
            ;ShareAnimation                = Yes 
            StateName                    = STATE_SelectedAlternateFormation
            Animation
                AnimationName            = DUPhalanx_ATNB
                AnimationMode            = LOOP
            End
        End
        AnimationState                        = ALTERNATE_FORMATION WEAPONSET_TOGGLE_1
            Animation
                AnimationName                = DUPhalanx_IDLA
                AnimationMode                = LOOP
            End
        End
        AnimationState                    = RAISING_FLAG
            Animation                    = CHRA
                AnimationName            = DUPhalanx_CHRA
                AnimationMode            = ONCE
                AnimationSpeedFactorRange = 0.9 1.1
            End
            Animation                    = CHRA
                AnimationName            = DUPhalanx_CHRB
                AnimationMode            = ONCE
                AnimationSpeedFactorRange = 0.9 1.1
            End
            Animation                    = CHRA
                AnimationName            = DUPhalanx_CHRC
                AnimationMode            = ONCE
                AnimationSpeedFactorRange = 0.9 1.1
            End
            Flags                        = RESTART_ANIM_WHEN_COMPLETE
        End
        AnimationState                    = SELECTED
            StateName                    = STATE_Selected
            ShareAnimation                = Yes
            Animation                    = ATNB
                AnimationName            = DUPhalanx_ATNB
                AnimationMode            = LOOP
            End
            BeginScript
                Prev = CurDrawablePrevAnimationState()
                if Prev == "STATE_Planted" then CurDrawableSetTransitionAnimState("TRANS_Unplant") end
            EndScript
        End
;======== IDLE
        AnimationState                    = ALTERNATE_FORMATION 
            StateName                    = STATE_Planted
            ;ShareAnimation                = Yes
            Animation                    = IDLB
                AnimationName            = DUPhalanx_PLTB
                AnimationMode            = LOOP
            End
            BeginScript
                Prev = CurDrawablePrevAnimationState()
                if Prev ~= "STATE_SelectedAlternateFormation" and Prev ~= "STATE_Planted" and Prev ~= "TRANS_Plant" then CurDrawableSetTransitionAnimState("TRANS_Plant") end
            EndScript
        End
        IdleAnimationState
            StateName                    = STATE_Idle
            Animation                    = ATNB
                AnimationName            = DUPhalanx_IDLA
                AnimationMode            = ONCE
            End
            Animation                    = ATNB
                AnimationName            = DUPhalanx_IDLB
                AnimationMode            = ONCE
            End
            BeginScript
                Prev = CurDrawablePrevAnimationState()
                if Prev == "STATE_Planted" then CurDrawableSetTransitionAnimState("TRANS_Unplant") end
            EndScript
        End
;-------------------------------------------------------------------------------------------------------------
    End

	; ***DESIGN parameters ***
	Side			                = Rivendell
	EditorSorting		          = UNIT
	ThreatLevel		            = 1.0
	ThingClass		            = HORDE_UNIT
	CommandPoints		          = 0
	TransportSlotCount 	      = 1
  
  ;;; WEAPON SETS ;;;
	WeaponSet
		Conditions	            = None 
		Weapon		              = PRIMARY DwarvenPhalanxPike 
		AutoChooseSources	      = PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI
	End

	ArmorSet
		Conditions              = None
		Armor                   = SpearmanHeavyArmor
		DamageFX                = NormalDamageFX
	End

	BuildFadeInOnCreateTime		= 0 
	VisionRange               = DWARVEN_PHALANX_VISION_RANGE
	ShroudClearingRange       = SHROUD_CLEAR_STANDARD
	BountyValue 		          = DWARVEN_PHALANX_BOUNTY_VALUE
	DisplayName 		          = OBJECT:DwarvenPhalanx
	CrushableLevel		        = 0		;//What am I?:        0 = for infantry, 1 = for trees, 2 = general vehicles
	CrusherLevel		          = 0		;//What can I crush?: 0 = small animals, 1 = infantry, 2 = trees, 3 = vehicles
 	CrushRevengeWeapon	      = AntiCavalryInfantryCrushRevenge
	CommandSet                = DwarvenPhalanxCommandSet

	; *** AUDIO Parameters ***;
	VoiceAttack								          = DwarfPhalanxVoiceAttack
	VoiceAttackCharge						        = DwarfPhalanxVoiceAttackCharge
	VoiceAttackMachine						      = DwarfPhalanxVoiceAttack
	VoiceAttackStructure					      = DwarfPhalanxVoiceAttackBuilding
	VoiceCreated							          = DwarfPhalanxVoiceSalute
	VoiceFullyCreated 						      = DwarfPhalanxVoiceSalute
	VoiceGuard								          = DwarfPhalanxVoiceMove
	VoiceMove								            = DwarfPhalanxVoiceMove
	VoiceMoveToCamp							        = DwarfPhalanxVoiceMoveCamp
	VoiceMoveWhileAttacking					    = DwarfPhalanxVoiceDisengage
	VoicePriority							          = 54
	VoiceRetreatToCastle					      = DwarfPhalanxVoiceRetreat		
	VoiceSelect								          = DwarfPhalanxVoiceSelect
	VoiceSelectBattle 						      = DwarfPhalanxVoiceSelectBattle			
	VoiceEnterStateAttack					      = DwarfPhalanxVoiceEnterStateAttack
	VoiceEnterStateAttackCharge				  = DwarfPhalanxVoiceEnterStateAttackCharge
	VoiceEnterStateAttackMachine			  = DwarfPhalanxVoiceEnterStateAttack
	VoiceEnterStateAttackStructure			= DwarfPhalanxVoiceEnterStateAttackBuilding
	VoiceEnterStateMove						      = DwarfPhalanxVoiceEnterStateMove
	VoiceEnterStateMoveToCamp				    = DwarfPhalanxVoiceEnterStateMoveCamp
	VoiceEnterStateMoveWhileAttacking		= DwarfPhalanxVoiceEnterStateDisengage
	VoiceEnterStateRetreatToCastle			= DwarfPhalanxVoiceEnterStateRetreat		
	
	SoundImpact								          = ImpactHorse
	EvaEventDamagedOwner                = UnitUnderAttack		;Eva event to trigger when unit is damaged
	
	Behavior                            = LargeGroupAudioUpdate ModuleTag_LGAU		; Tie into LargeGroupAudio system
		Key                               = Dwarf Unit Infantry Hero
	End
	
	UnitSpecificSounds                    
		VoiceGarrison						          = DwarfPhalanxVoiceMoveGarrison
	End
	
	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:BodyFallOrc			Animation:DUPHALANX_SKL.DUPHALANX_LNDA	Frames:6
		AnimationSound = Sound:BodyFallGeneric1		Animation:DUPHALANX_SKL.DUPHALANX_DIEA	Frames:13
		AnimationSound = Sound:BodyFallGeneric1		Animation:DUPHALANX_SKL.DUPHALANX_DIEB	Frames:45
		AnimationSound = Sound:BodyFallGeneric1		Animation:DUPHALANX_SKL.DUPHALANX_DIEC	Frames:22
	End

	;// *** ENGINEERING Parameters ***
	RadarPriority = UNIT
	KindOf = PRELOAD SELECTABLE CAN_CAST_REFLECTIONS INFANTRY PATH_THROUGH_EACH_OTHER SCORE THROWN_OBJECT GRAB_AND_DROP ATTACK_NEEDS_LINE_OF_SIGHT SUMMONED

	Body				                    =	PorcupineFormationBodyModule ModuleTag_porcupineFormation
		CheerRadius 				          =	EMOTION_CHEER_RADIUS
		MaxHealth					            =	400				
		MaxHealthDamaged			        =	225			
		DamageWeaponTemplate		      =	PikemenPorcupineDamage
		CrushDamageWeaponTemplate	    =	PikemenPorcupineCrushDamage
	End
	
	Behavior                        = AIUpdateInterface ModuleTag_03
		AutoAcquireEnemiesWhenIdle		= Yes 
		AILuaEventsList					      = DwarvenGuardianFunctions   
		MoodAttackCheckRate				    = 500
		AttackPriority					      = AttackPriority_Infantry
	End

	LocomotorSet
		Locomotor                     = HumanLocomotor
		Condition                     = SET_NORMAL
		Speed                         = NORMAL_GOOD_HERO_SPEED		
	End
	
	LocomotorSet
		Locomotor                     = HumanLocomotor
		Condition                     = SET_NORMAL_UPGRADED
		Speed                         = 50		
	End

	Behavior                        = PhysicsBehavior ModuleTag_04
		GravityMult				            = 1.0
		ShockStunnedTimeLow		        = 1400 ;//msec
		ShockStunnedTimeHigh	        = 2400 ;//msec
		ShockStandingTime		          = 2133 ;//msec
	End
 
	Behavior                        = SlowDeathBehavior ModuleTag_05
		DeathTypes			              = ALL -KNOCKBACK -FADED
		SinkDelay			                = 3000
		SinkRate			                = 0.40     ;// in Dist/Sec
		DestructionDelay	            = 8000
		Sound				                  = INITIAL DwarfPhalanxVoiceDie
	End
	 
	Behavior                        = SlowDeathBehavior ModuleTag_07
		DeathTypes			              = NONE +KNOCKBACK
		SinkDelay			                = 3000
		SinkRate			                = 0.40     ;// in Dist/Sec
		DestructionDelay	            = 8000
	End
	
	Behavior = SlowDeathBehavior ModuleTag_FadeDeath
			DeathTypes                  = NONE +FADED
			FadeDelay                   = 0
			FadeTime                    = 8000
			DestructionDelay            = 8000
			DeathFlags                  = DEATH_2
			FX                          = INITIAL FX_RohirrimAlliesUnsummon
	End
	
	Behavior                        = SquishCollide ModuleTag_06
		;//nothing
	End
	 
	Behavior                        = BezierProjectileBehavior ModuleTag_08 ;// Module starts asleep, and wakes up when thrown.		 
		FirstHeight					          = 24  ;// Height of Bezier control points above highest intervening terrain
		SecondHeight				          = 24
		FirstPercentIndent			      = 30% ;// Percentage of shot distance control points are placed
		SecondPercentIndent			      = 70%
		TumbleRandomly				        = Yes

		CrushStyle					          = Yes ;// I don't detonate, I just hit
		DieOnImpact					          = Yes
		BounceCount					          = 1   ;// When I hit the ground, I'll arc again
		BounceDistance				        = 40  ;// this far
		BounceFirstHeight			        = 24  ;// Height of Bezier control points above highest intervening terrain
		BounceSecondHeight			      = 24
		BounceFirstPercentIndent	    = 20% ;// Percentage of shot distance control points are placed
		BounceSecondPercentIndent	    = 80%

		GroundHitFX                   = FX_ThrownRockGroundHit
		GroundBounceFX                = FX_ThrownRockBounceHit
	End

	Behavior                        = HordeMemberCollide ModuleTag_HMC
		;//nothing
	End
	 
	;--Weapon--
	Behavior                        = SubObjectsUpgrade ForgedBlade_UpgradeGuardian
		TriggeredBy		              	= Upgrade_RivendellForgedBlades
		ShowSubObjects	              = Forged_Blade
	End	
	
	;--Armor--
	Behavior                        = SubObjectsUpgrade Armor_UpgradeGuardian
		TriggeredBy		              	= Upgrade_RivendellHeavyArmor
		RecolorHouse	                = Yes
		ShowSubObjects	              = HA
		ExcludeSubobjects             = Forged_Blade
	End

	Behavior                        = SubObjectsUpgrade Helmet_Upgrade
		TriggeredBy		              	= Upgrade_RivendellHeavyArmor
		ShowSubObjects	              = MASK
	End	
	
	; -- Summoned Stuff
	Behavior         = LifetimeUpdate ModuleTag_LifetimeUpdate
		MinLifetime    = 75000 ; 180000
		MaxLifetime    = 75000 ; 180000
		DeathType      = FADED
	End
	
	Behavior         = GrantUpgradeCreate ModuleTag_GrantForgedBlades
		UpgradeToGrant = Upgrade_RivendellForgedBlades
	End
	
	Behavior         = GrantUpgradeCreate ModuleTag_GrantMithrilMail
		UpgradeToGrant = Upgrade_RivendellHeavyArmor
	End
	
	Scale               = 0.98
	Geometry			      = CYLINDER
	GeometryMajorRadius = 8
	GeometryMinorRadius = 8
	GeometryHeight		  = 19.2
	GeometryIsSmall		  = Yes
	Shadow				      = SHADOW_DECAL
	ShadowSizeX 		    = 21;
	ShadowSizeY 		    = 21;
	ShadowTexture		    = ShadowI;
End
